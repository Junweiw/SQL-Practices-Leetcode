# SQL Practices On LeetCode
This file includes my solutions to LeetCode SQL questions in MySQL.

## Question List
### Easy
[Q175](#q175-combine-two-tables) | [Q176](#q176-second-highest-salary) | [Q181](#q181-employees-earning-more-than-their-managers) | [Q182](#q182-duplicate-emails) | [Q183](#q183-customers-who-never-order) | [Q196](#q196-delete-duplicate-emails) |[Q197](#q197-rising-temperature) | [Q511](#q511-game-play-analysis-i) | [Q512](#q512-game-play-analysis-ii) | [Q577](#q577-employee-bonus) | [Q584](#q584-find-customer-referee) | [Q586](#q586-customer-placing-the-largest-number-of-orders) | [Q595](#q595-big-countries) | [Q596](#q596-classes-more-than-5-students) | [Q597](#q597-friend-requests-i-overall-acceptance-rate) | [Q603](#q603-consecutive-available-seats) | [Q607](#q607-sales-person) | [Q610](#q610-triangle-judgement) | [Q613](#q613-shortest-distance-in-a-line) | [Q619](#q619-biggest-single-number) | [Q620](#q620-not-boring-movies) | [Q627](#q627-swap-salary) | [Q1050](#q1050-actors-and-directors-who-cooperated-at-least-three-times) | [Q1068](#q1068-product-sales-analysis-i) | [Q1069](#q1069-product-sales-analysis-ii) | [Q1075](#q1075-project-employees-i) | [Q1076](#q1076-project-employees-ii) | [Q1082](#q1082-sales-analysis-i) | [Q1083](#q1083-sales-analysis-ii) | [Q1084](#q1084-sales-analysis-iii) | [Q1113](#q1113-reported-posts) | [Q1141](#q1141-user-activity-for-the-past-30-days-i) | [Q1142](#q1142-user-activity-for-the-past-30-days-ii) | [Q1148](#q1148-article-views-i) | [Q1173](#q1173-immediate-food-delivery-i) | [Q1179](#q1179-reformat-department-table) | [Q1211](#q1211-queries-quality-and-percentage) | [Q1241](#q1241-number-of-comments-per-post) | [Q1251](#q1251-average-selling-price) | [Q1280](#q1280-students-and-examinations) | [Q1294](#q1294-weather-type-in-each-country) | [Q1303](#q1303-find-the-team-size) | [Q1322](#q1322-ads-performance) | [Q1327](#q1327-list-the-products-ordered-in-a-period) | [Q1350](#q1350-students-with-invalid-departments) | [Q1378](#q1378-replace-employee-id-with-the-unique-identifier) | [Q1407](#q1407-top-travellers) | [Q1435](#q1435-create-a-session-bar-chart) | [Q1484](#q1484-group-sold-products-by-the-date) | [Q1495](#q1495-friendly-movies-streamed-last-month)

### Medium
[Q177](#q177-nth-highest-salary) | [Q178](#q178-rank-scores) | [Q180](#q180-consecutive-numbers) | [Q184](#q184-department-highest-salary) | [Q534](#q534-game-play-analysis-iii) | [Q550](#q550-game-play-analysis-iv) | [Q570](#q570-managers-with-at-least-5-direct-reports) | [Q574](#q574-winning-candidate) | [Q578](#q578-get-highest-answer-rate-question) | [580](#q580-count-student-number-in-departments) | [Q585](#q585-investments-in-2016) | [Q602](#q602-friend-requests-ii-who-has-the-most-friends) | [Q608](#q608-tree-node) | [Q612](#q612-shortest-distance-in-a-plane) | [Q614](#q614-second-degree-follower) | [Q626](#q626-exchange-seats) | [Q1045](#q1045-customers-who-bought-all-products) | [Q1070](#q1070-product-sales-analysis-iii) | [Q1077](#q1077-project-employees-iii) | [Q1098](#q1098-unpopular-books) | [Q1107](#q1107-new-users-daily-count) | [Q1112](#q1112-highest-grade-for-each-student) | [Q1126](#q1126-active-businesses) | [Q1132](#q1132-reported-posts-ii) | [Q1149](#q1149-article-views-ii) | [Q1158](#q1158-market-analysis-i) | [Q1164](#q1164-product-price-at-a-given-date) | [Q1174](#q1174-immediate-food-delivery-ii) | [Q1193](#q1193-monthly-transactions-i) | [Q1204](#q1204-last-person-to-fit-in-the-elevator) | [Q1205](#q1205-monthly-transactions-ii) | [Q1212](#q1212-team-scores-in-football-tournament) | [Q1264](#q1264-page-recommendations) | [Q1270](#q1270-all-people-report-to-the-given-manager) | [Q1285](#q1285-find-the-start-and-end-number-of-continuous-ranges) | [Q1308](#q1308-running-total-for-different-genders) | [Q1321](#q1321-restaurant-growth) | [Q1341](#q1341-movie-rating) | [Q1355](#q1355-activity-participants) | [Q1364](#q1364-number-of-trusted-contacts-of-a-customer) | [Q1393](#q1393-capital-gainloss) | [Q1398](#q1398-customers-who-bought-products-a-and-b-but-not-c) | [Q1421](#q1421-npv-queries) | [Q1440](#q1440-evaluate-boolean-expression) | [Q1445](#q1445-apples-and-oranges) | [Q1454](#q1454-active-users) | [Q1459](#q1459-rectangles-area) | [Q1468](#q1468-calculate-salaries) | [Q1501](#q1501-countries-you-can-safely-invest-in) | [Q1532](#q1532-the-most-recent-three-orders)

### Hard
[Q185](#q185-department-top-three-salaries) | [Q262](#q262-trips-and-users) | [Q569](#q569-median-employee-salary) | [Q571](#q571-find-median-given-frequency-of-numbers) | [Q579](#q579-find-cumulative-salary-of-an-employee) | [Q601](#q601-human-traffic-of-stadium) | [Q615](#q615-average-salary-departments-vs-company) | [Q618](#q618-students-report-by-geography) | [Q1097](#q1097-game-play-analysis-v) | [Q1127](#q1127-user-purchase-platform) | [Q1159](#q1159-market-analysis-ii) | [Q1194](#q1194-tournament-winners) | [Q1225](#q1225-report-contiguous-dates) | [Q1336](#q1336-number-of-transactions-per-visit) | [Q1369](#q1369-get-the-second-most-recent-activity) | [Q1384](#q1384-total-sales-amount-by-year) | [Q1412](#q1412-find-the-quiet-students-in-all-exams) | [Q1479](#q1479-sales-by-day-of-the-week)

## Solutions
#### [**Q175 Combine Two Tables**][Q175]
```sql
SELECT FirstName, LastName, City, State
FROM Person
LEFT JOIN Address
ON Person.PersonId = Address.PersonId
```
##### [**Back to Question List**](#question-list)
[Q175]:
https://leetcode.com/problems/combine-two-tables/

#### [**Q176 Second Highest Salary**][Q176]
```sql
SELECT MAX(Salary) AS SecondHighestSalary
FROM Employee
WHERE Salary < (SELECT MAX(Salary) FROM Employee)
```
##### [**Back to Question List**](#question-list)
[Q176]:
https://leetcode.com/problems/second-highest-salary/

#### [**Q181 Employees Earning More Than Their Managers**][Q181]
```sql
SELECT Name AS Employee   
FROM
    (SELECT T1.Name, T1.Salary AS Employee_Salary,T2.Salary AS Manager_Salary 
     FROM Employee T1 LEFT JOIN Employee T2
    ON T1.ManagerId = T2.Id) T3
WHERE Employee_Salary > Manager_Salary
```
##### [**Back to Question List**](#question-list)
[Q181]:
https://leetcode.com/problems/employees-earning-more-than-their-managers/

#### [**Q182 Duplicate Emails**][Q182]
```sql
SELECT Email
FROM Person
GROUP BY Email
HAVING COUNT(Id)>1
```
##### [**Back to Question List**](#question-list)
[Q182]:
https://leetcode.com/problems/duplicate-emails/

#### [**Q183 Customers Who Never Order**][Q183]
```sql
SELECT Name AS Customers
FROM Customers
LEFT JOIN
    (SELECT CustomerId, COUNT(Id) AS Order_Count
    FROM Orders
    GROUP BY CustomerId) T1
ON Customers.Id = T1.CustomerId
WHERE T1.Order_Count IS NULL
```
##### [**Back to Question List**](#question-list)
[Q183]:
https://leetcode.com/problems/customers-who-never-order/

#### [**Q196 Delete Duplicate Emails**][Q196]
```sql
DELETE 
FROM Person
WHERE Id NOT IN(SELECT Min_id
FROM
(SELECT MIN(Id) AS Min_id,Email
FROM Person
GROUP BY Email) T1)
```
##### [**Back to Question List**](#question-list)
[Q196]:
https://leetcode.com/problems/delete-duplicate-emails/

#### [**Q197 Rising Temperature**][Q197]
```sql
SELECT T1.Id
FROM Weather AS T1, Weather AS T2
WHERE DATEDIFF(T1.RecordDate, T2.RecordDate) = 1 
AND T1.Temperature > T2.Temperature
```
##### [**Back to Question List**](#question-list)
[Q197]:
https://leetcode.com/problems/rising-temperature/

#### [**Q511 Game Play Analysis I**][Q511]
```sql
SELECT player_id, MIN(event_date) AS first_login
FROM Activity
GROUP BY player_id
```
##### [**Back to Question List**](#question-list)
[Q511]:
https://leetcode.com/problems/game-play-analysis-i/

#### [**Q512 Game Play Analysis II**][Q512]
```sql
SELECT player_id, device_id
FROM
    (SELECT player_id, device_id, MIN(event_date) OVER (PARTITION BY        player_id) AS earliest, event_date
    FROM Activity) T1
WHERE event_date = earliest
```
##### [**Back to Question List**](#question-list)
[Q512]:
https://leetcode.com/problems/game-play-analysis-ii/

#### [**Q577 Employee Bonus**][Q577]
```sql
SELECT name, bonus
FROM Employee
LEFT JOIN Bonus
ON Employee.empId = Bonus.empId
WHERE bonus < 1000 OR bonus is NULL
```
##### [**Back to Question List**](#question-list)
[Q577]:
https://leetcode.com/problems/employee-bonus/

#### [**Q584 Find Customer Referee**][Q584]
```sql
SELECT name
FROM customer
WHERE referee_id !=2 OR referee_id IS NULL
```
##### [**Back to Question List**](#question-list)
[Q584]:
https://leetcode.com/problems/find-customer-referee/

#### [**Q586 Customer Placing the Largest Number of Orders**][Q586]
```sql
SELECT customer_number
FROM
    (SELECT COUNT(order_number) AS order_count, customer_number
    FROM orders
    GROUP BY customer_number) T1
WHERE order_count = (SELECT MAX(order_count) 
                     FROM 
                     (SELECT 
                      COUNT(order_number) AS order_count
                      FROM orders
                      GROUP BY customer_number) T2)
```
##### [**Back to Question List**](#question-list)
[Q586]:
https://leetcode.com/problems/customer-placing-the-largest-number-of-orders/

#### [**Q595 Big Countries**][Q595]
```sql
SELECT name, population, area
FROM World
WHERE area > 3000000 OR population > 25000000
```
##### [**Back to Question List**](#question-list)
[Q595]:
https://leetcode.com/problems/big-countries/

#### [**Q596 Classes More Than 5 Students**][Q596]
```sql
SELECT class
FROM courses
GROUP BY class
HAVING COUNT(DISTINCT student) >= 5
```
##### [**Back to Question List**](#question-list)
[Q596]:
https://leetcode.com/problems/classes-more-than-5-students/

#### [**Q597 Friend Requests I: Overall Acceptance Rate**][Q597]
```sql
SELECT ROUND(COALESCE(T2_1.requester_count/T1_1.sender_count,0),2) AS accept_rate
FROM
    (SELECT COUNT(T1.sender_id) AS sender_count
     FROM
     (SELECT sender_id
      FROM friend_request
      GROUP BY sender_id, sender_id + send_to_id) T1) T1_1,
    
    (SELECT COUNT(T2.requester_id) AS requester_count
     FROM
     (SELECT requester_id
     FROM request_accepted
     GROUP BY requester_id, requester_id + accepter_id) T2) T2_1
```
##### [**Back to Question List**](#question-list)
[Q597]:
https://leetcode.com/problems/friend-requests-i-overall-acceptance-rate/

#### [**Q603 Consecutive Available Seats**][Q603]
```sql
SELECT current.seat_id
FROM cinema AS current
LEFT JOIN cinema AS last
ON current.seat_id = last.seat_id-1
LEFT JOIN cinema AS next
ON current.seat_id = next.seat_id+1
WHERE current.free = 1 AND COALESCE(current.free,0) + COALESCE(last.free,0) + COALESCE(next.free,0) >= 2
ORDER BY current.seat_id
```
##### [**Back to Question List**](#question-list)

[Q603]:
https://leetcode.com/problems/consecutive-available-seats/

#### [**Q607 Sales Person**][Q607]
```sql
SELECT name
FROM salesperson
WHERE salesperson.sales_id 
    NOT IN (SELECT DISTINCT sales_id 
            FROM orders
            LEFT JOIN company
            ON orders.com_id = company.com_id
            WHERE company.name = "RED")
```
##### [**Back to Question List**](#question-list)
[Q607]:
https://leetcode.com/problems/sales-person/

#### [**Q610 Triangle Judgement**][Q610]
```sql
SELECT x, y, z,
    CASE 
        WHEN x+y > z AND x+z > y AND y+z > x THEN 'Yes'
        ELSE 'No'
    END AS triangle
FROM triangle
```
##### [**Back to Question List**](#question-list)
[Q610]:
https://leetcode.com/problems/triangle-judgement/

#### [**Q613 Shortest Distance in a Line**][Q613]
```sql
SELECT MIN(distance) AS shortest
FROM
    (SELECT LEAD(x,1) OVER() - x AS distance
    FROM point
    ORDER BY x) T1
```
##### [**Back to Question List**](#question-list)
[Q613]:
https://leetcode.com/problems/shortest-distance-in-a-line/

#### [**Q619 Biggest Single Number**][Q619]
```sql
SELECT MAX(num) AS num
FROM
    (SELECT num
     FROM my_numbers
     GROUP BY num
     HAVING COUNT(num)=1) T1
```
##### [**Back to Question List**](#question-list)
[Q619]:
https://leetcode.com/problems/biggest-single-number/

#### [**Q620 Not Boring Movies**][Q620]
```sql
SELECT *
FROM cinema
WHERE id%2=1 AND description != 'boring'
ORDER BY rating DESC
```
##### [**Back to Question List**](#question-list)
[Q620]:
https://leetcode.com/problems/not-boring-movies/

#### [**Q627 Swap Salary**][Q627]
```sql
UPDATE salary
SET sex = CASE sex
            WHEN 'm' THEN 'f'
            ELSE 'm'
          END
```
##### [**Back to Question List**](#question-list)
[Q627]:
https://leetcode.com/problems/swap-salary/

#### [**Q1050 Actors and Directors Who Cooperated At Least Three Times**][Q1050]
```sql
SELECT actor_id, director_id
FROM ActorDirector
GROUP BY actor_id, director_id
HAVING COUNT(timestamp) >= 3
```
##### [**Back to Question List**](#question-list)
[Q1050]:
https://leetcode.com/problems/actors-and-directors-who-cooperated-at-least-three-times/

#### [**Q1068 Product Sales Analysis I**][Q1068]
```sql
SELECT Product.product_name, Sales.year, Sales.price
FROM Sales
LEFT JOIN Product
ON Sales.product_id = Product.product_id
```
##### [**Back to Question List**](#question-list)
[Q1068]:
https://leetcode.com/problems/product-sales-analysis-i/

#### [**Q1069 Product Sales Analysis II**][Q1069]
```sql
SELECT product_id, SUM(quantity) AS total_quantity
FROM Sales
GROUP BY Sales.product_id
```
##### [**Back to Question List**](#question-list)
[Q1069]:
https://leetcode.com/problems/product-sales-analysis-ii/

#### [**Q1075 Project Employees I**][Q1075]
```sql
SELECT project_id, ROUND(AVG(experience_years),2) AS average_years
FROM Project
LEFT JOIN Employee
ON Project.employee_id = Employee.employee_id
GROUP BY project_id
```
##### [**Back to Question List**](#question-list)
[Q1075]:
https://leetcode.com/problems/project-employees-i/

#### [**Q1076 Project Employees II**][Q1076]
```sql
SELECT project_id
FROM project
GROUP BY project_id
HAVING COUNT(employee_id) = (SELECT COUNT(employee_id)
                             FROM project
                             GROUP BY project_id
                             ORDER BY COUNT(employee_id) DESC
                             LIMIT 1)
```
##### [**Back to Question List**](#question-list)
[Q1076]:
https://leetcode.com/problems/project-employees-ii/

#### [**Q1082 Sales Analysis I**][Q1082]
```sql
SELECT seller_id
FROM Sales
GROUP BY seller_id
HAVING SUM(price) = 
    (SELECT SUM(price)
    FROM Sales
    GROUP BY seller_id
    ORDER BY SUM(price) DESC
    LIMIT 1)
```
##### [**Back to Question List**](#question-list)
[Q1082]:
https://leetcode.com/problems/sales-analysis-i/

#### [**Q1083 Sales Analysis II**][Q1083]
```sql
SELECT DISTINCT buyer_id
FROM Sales
LEFT JOIN Product
ON Sales.product_id = Product.product_id
WHERE buyer_id NOT IN ( SELECT buyer_id
                        FROM Sales
                        LEFT JOIN Product
                        ON Sales.product_id = Product.product_id
                        WHERE product_name ='iPhone')
AND product_name = 'S8'
```
##### [**Back to Question List**](#question-list)
[Q1083]:
https://leetcode.com/problems/sales-analysis-ii/

#### [**Q1084 Sales Analysis III**][Q1084]
```sql
SELECT product_id, product_name
FROM Product
WHERE product_id NOT IN ( SELECT DISTINCT product_id
                        FROM Sales
                        WHERE sale_date > DATE('2019-03-31')
                        OR sale_date < DATE('2019-01-01'))
```
##### [**Back to Question List**](#question-list)
[Q1084]:
https://leetcode.com/problems/sales-analysis-iii/

#### [**Q1113 Reported Posts**][Q1113]
```sql
SELECT extra AS report_reason, COUNT(DISTINCT post_id) AS report_count
FROM Actions
WHERE action = 'report' AND action_date = DATE('2019-07-04')
GROUP BY extra
HAVING COUNT(DISTINCT post_id) > 0
```
##### [**Back to Question List**](#question-list)
[Q1113]:
https://leetcode.com/problems/reported-posts/

#### [**Q1141 User Activity for the Past 30 Days I**][Q1141]
```sql
SELECT activity_date AS day, COUNT(DISTINCT user_id) AS active_users
FROM Activity
WHERE activity_date BETWEEN DATE_ADD('2019-07-27', INTERVAL -29 DAY) AND DATE('2019-07-27')
GROUP BY activity_date
```
##### [**Back to Question List**](#question-list)
[Q1141]:
https://leetcode.com/problems/user-activity-for-the-past-30-days-i/

#### [**Q1142 User Activity for the Past 30 Days II**][Q1142]
```sql
SELECT ROUND(COALESCE(COUNT(DISTINCT session_id)/COUNT(DISTINCT user_id),0),2) AS average_sessions_per_user
FROM Activity
WHERE activity_date
    BETWEEN DATE_ADD('2019-07-27', INTERVAL -29 DAY) AND DATE('2019-07-27')
```
##### [**Back to Question List**](#question-list)
[Q1142]:
https://leetcode.com/problems/user-activity-for-the-past-30-days-ii/

#### [**Q1148 Article Views I**][Q1148]
```sql
SELECT DISTINCT author_id AS id
FROM Views
WHERE author_id = viewer_id
ORDER BY author_i
```
##### [**Back to Question List**](#question-list)
[Q1148]:
https://leetcode.com/problems/article-views-i/

#### [**Q1173 Immediate Food Delivery I**][Q1173]
```sql
SELECT ROUND(COALESCE(T1.immediate/T2.Tot*100,0),2) AS immediate_percentage
FROM
    (SELECT COUNT(delivery_id) AS Immediate
     FROM Delivery
     WHERE Delivery.order_date = Delivery.customer_pref_delivery_date) T1,
     (SELECT COUNT(delivery_id) AS Tot
      FROM Delivery) T2
```
##### [**Back to Question List**](#question-list)
[Q1173]:
https://leetcode.com/problems/immediate-food-delivery-i/

#### [**Q1179 Reformat Department Table**][Q1179]
```sql
SELECT id, 
SUM(Jan) AS Jan_Revenue, SUM(Feb) AS Feb_Revenue, SUM(Mar) AS Mar_Revenue,
SUM(Apr) AS Apr_Revenue, SUM(May) AS May_Revenue, SUM(Jun) AS Jun_Revenue,
SUM(Jul) AS Jul_Revenue, SUM(Aug) AS Aug_Revenue, SUM(Sep) AS Sep_Revenue, 
SUM(Oct) AS Oct_Revenue, SUM(Nov) AS Nov_Revenue, SUM(DecE) AS Dec_Revenue
FROM   (SELECT id,
       (CASE month WHEN 'Jan' THEN revenue END) AS Jan,
       (CASE month WHEN 'Feb' THEN revenue END) AS Feb,
       (CASE month WHEN 'Mar' THEN revenue END) AS Mar,
       (CASE month WHEN 'Apr' THEN revenue END) AS Apr,
       (CASE month WHEN 'May' THEN revenue END) AS May,
       (CASE month WHEN 'Jun' THEN revenue END) AS Jun, 
       (CASE month WHEN 'Jul' THEN revenue END) AS Jul,
       (CASE month WHEN 'Aug' THEN revenue END) AS Aug,
       (CASE month WHEN 'Sep' THEN revenue END) AS Sep,
       (CASE month WHEN 'Oct' THEN revenue END) AS Oct,
       (CASE month WHEN 'Nov' THEN revenue END) AS Nov,
       (CASE month WHEN 'Dec' THEN revenue END) AS DecE
        FROM Department) T1
GROUP BY id
```
##### [**Back to Question List**](#question-list)
[Q1179]:
https://leetcode.com/problems/reformat-department-table/

#### [**Q1211 Queries Quality and Percentage**][Q1211]
```sql
SELECT query_name, ROUND(SUM(quality)/COUNT(query_name),2) AS quality, ROUND(SUM(poor_query)/COUNT(query_name) * 100,2) AS poor_query_percentage
FROM
    (SELECT query_name, 
     CASE WHEN rating < 3 THEN 1 ELSE 0 END AS poor_query, 
     rating/position AS quality
     FROM Queries) T1
GROUP BY query_name
```
##### [**Back to Question List**](#question-list)
[Q1211]:
https://leetcode.com/problems/queries-quality-and-percentage/

#### [**Q1241 Number of Comments per Post**][Q1241]
```sql
SELECT post_id, COUNT(DISTINCT sub_id)-1 AS number_of_comments
FROM
    (SELECT IFNULL(parent_id, sub_id) AS post_id , sub_id, parent_id
    FROM Submissions) T1
WHERE post_id IN (
    SELECT DISTINCT sub_id AS post_id
    FROM Submissions
    WHERE parent_id IS NULL
    GROUP BY sub_id)
GROUP BY post_id
```
##### [**Back to Question List**](#question-list)
[Q1241]:
https://leetcode.com/problems/number-of-comments-per-post/

#### [**Q1251 Average Selling Price**][Q1251]
```sql
SELECT product_id, ROUND(SUM(sales)/SUM(units),2) AS average_price
FROM
     (SELECT UnitsSold.product_id, purchase_date, units,units*price AS sales
     FROM UnitsSold
     LEFT JOIN Prices
     ON UnitsSold.product_id = Prices.product_id
     WHERE purchase_date BETWEEN start_date AND end_date) T1
GROUP BY product_id
```
##### [**Back to Question List**](#question-list)
[Q1251]:
https://leetcode.com/problems/average-selling-price/

#### [**Q1280 Students and Examinations**][Q1280]
```sql
SELECT T1.student_id, T1.student_name, T1.subject_name, COALESCE(T2.exam_counts,0) AS attended_exams
FROM
(SELECT *
 FROM Students, Subjects) T1
LEFT JOIN
(SELECT student_id, subject_name, COUNT(*) AS exam_counts
 FROM Examinations
 GROUP BY student_id, subject_name) T2
ON T1.Student_id = T2.Student_id AND T1.subject_name = T2.subject_name
ORDER BY T1.student_id, T1.subject_name, COALESCE(T2.exam_counts,0) DESC
```
##### [**Back to Question List**](#question-list)
[Q1280]:
https://leetcode.com/problems/students-and-examinations/

#### [**Q1294 Weather Type in Each Country**][Q1294]
```sql
SELECT Countries.country_name,
    CASE WHEN AVG(Weather.weather_state) <= 15 THEN "Cold"
         WHEN AVG(Weather.weather_state) >= 25 THEN "Hot"
         ELSE "Warm" 
    END AS weather_type
FROM Weather
LEFT JOIN Countries
ON Weather.country_id = Countries.country_id
WHERE Weather.day BETWEEN DATE("2019-11-01") AND DATE("2019-11-30")
GROUP BY Countries.country_name
```
##### [**Back to Question List**](#question-list)
[Q1294]:
https://leetcode.com/problems/weather-type-in-each-country/

#### [**Q1303 Find the Team Size**][Q1303]
```sql
SELECT employee_id, team_size
FROM Employee
LEFT JOIN (SELECT team_id, COUNT(Employee_id) AS team_size
           FROM Employee GROUP BY team_id) T1
ON Employee.team_id = T1.team_id
```
##### [**Back to Question List**](#question-list)
[Q1303]:
https://leetcode.com/problems/find-the-team-size/

#### [**Q1322 Ads Performance**][Q1322]
```sql
SELECT ad_id, ROUND(COALESCE(Clicks/(Views+Clicks)*100,0), 2) AS ctr
FROM
    (SELECT ad_id, SUM(CASE action WHEN "Clicked" THEN 1 ELSE 0 END) AS "Clicks", 
                   SUM(CASE action WHEN "Viewed" THEN 1 ELSE 0 END) AS "Views"
     FROM Ads
     GROUP BY ad_id) T1
ORDER BY ctr DESC, ad_id
```
##### [**Back to Question List**](#question-list)
[Q1322]:
https://leetcode.com/problems/ads-performance/

#### [**Q1327 List the Products Ordered in a Period**][Q1327]
```sql
SELECT product_name, unit
FROM (SELECT product_id, SUM(unit) AS unit
      FROM Orders
      WHERE order_date BETWEEN DATE("2020-02-01") AND DATE("2020-02-29")
      GROUP BY product_id) T1
LEFT JOIN Products
ON T1.product_id = Products.product_id
WHERE unit >= 100
```
##### [**Back to Question List**](#question-list)
[Q1327]:
https://leetcode.com/problems/list-the-products-ordered-in-a-period/

#### [**Q1350 Students With Invalid Departments**][Q1350]
```sql
SELECT Students.id, Students.name
FROM Students
LEFT JOIN Departments
ON Students.department_id = Departments.id
WHERE Departments.name IS NULL
```
##### [**Back to Question List**](#question-list)
[Q1350]:
https://leetcode.com/problems/students-with-invalid-departments/

#### [**Q1378 Replace Employee ID With The Unique Identifier**][Q1378]
```sql
SELECT unique_id, name
FROM Employees
LEFT JOIN EmployeeUNI
ON Employees.id = EmployeeUNI.id
```
##### [**Back to Question List**](#question-list)
[Q1378]:
https://leetcode.com/problems/replace-employee-id-with-the-unique-identifier/

#### [**Q1407 Top Travellers**][Q1407]
```sql
SELECT name, COALESCE(tot_distance,0) AS travelled_distance
FROM Users
LEFT JOIN (SELECT user_id, SUM(distance) AS tot_distance
           FROM Rides
           GROUP BY user_id) T1
ON Users.id = T1.user_id
ORDER BY COALESCE(tot_distance,0) DESC, name
```
##### [**Back to Question List**](#question-list)
[Q1407]:
https://leetcode.com/problems/top-travellers/

#### [**Q1435 Create a Session Bar Chart**][Q1435]
```sql
SELECT T1.bin, COALESCE(T2.total,0) AS total
FROM
    (SELECT '[0-5>' AS bin
     UNION ALL 
     SELECT '[5-10>' AS bin
     UNION ALL 
     SELECT '[10-15>' AS bin
     UNION ALL 
     SELECT '15 or more' AS bin)T1
    LEFT JOIN
    (SELECT COUNT(session_id) AS total,
      CASE WHEN duration/60 >= 0 AND duration/60 < 5 THEN "[0-5>"
            WHEN duration/60 >= 5 AND duration/60 < 10 THEN "[5-10>"
            WHEN duration/60 >= 10 AND duration/60 < 15 THEN "[10-15>"
            ELSE "15 or more"
      END AS bin
     FROM Sessions
     GROUP BY bin)T2
     ON T1.bin = T2.bin
```
##### [**Back to Question List**](#question-list)
[Q1435]:
https://leetcode.com/problems/create-a-session-bar-chart/

#### [**Q1484 Group Sold Products By The Date**][Q1484]
```sql
SELECT sell_date, 
       COUNT(DISTINCT product) AS num_sold,
       GROUP_CONCAT(DISTINCT product ORDER BY product) AS products
FROM Activities
GROUP BY sell_date
```
##### [**Back to Question List**](#question-list)
[Q1484]:
https://leetcode.com/problems/group-sold-products-by-the-date/

#### [**Q1495 Friendly Movies Streamed Last Month**][Q1495]
```sql
SELECT DISTINCT title AS TITLE
FROM TVProgram
LEFT JOIN Content
ON TVProgram.content_id = Content.content_id
WHERE program_date BETWEEN DATE('2020-06-01') AND DATE('2020-06-30')
    AND Kids_content = 'Y' AND content_type = 'Movies'
```
##### [**Back to Question List**](#question-list)
[Q1495]:
https://leetcode.com/problems/friendly-movies-streamed-last-month/

#### [**Q177 Nth Highest Salary**][Q177]
```sql
CREATE FUNCTION getNthHighestSalary(N INT) RETURNS INT
BEGIN
  RETURN (
      # Write your MySQL query statement below.
      SELECT DISTINCT Salary
      FROM    
        (SELECT Id, Salary, DENSE_RANK() OVER(ORDER BY Salary DESC) AS Ranking
         FROM Employee)T1
      WHERE Ranking = N
  );
END
```
##### [**Back to Question List**](#question-list)
[Q177]:
https://leetcode.com/problems/nth-highest-salary/

#### [**Q178 Rank Scores**][Q178]
```sql
SELECT Score, DENSE_RANK() OVER (ORDER BY score DESC) AS 'RANK'
FROM Scores
```
##### [**Back to Question List**](#question-list)
[Q178]:
https://leetcode.com/problems/rank-scores/

#### [**Q180 Consecutive Numbers**][Q180]
```sql
SELECT DISTINCT Num AS ConsecutiveNums
FROM
    (SELECT Num,lead(Num,1) OVER () AS LEAD_1, lead(Num,2) OVER() AS LEAD_2
     FROM Logs)T1
WHERE Num = LEAD_1 AND Num = LEAD_2 AND LEAD_1 = LEAD_2
```
##### [**Back to Question List**](#question-list)
[Q180]:
https://leetcode.com/problems/consecutive-numbers/

#### [**Q184 Department Highest Salary**][Q184]
```sql
SELECT Department,Employee ,Salary
FROM
    (SELECT Employee.Name AS Employee, Department.name AS Department ,Salary, 
     MAX(Salary) OVER (PARTITION BY Department.name) AS Department_max_salary
     FROM Employee
     LEFT JOIN Department
     ON Employee.DepartmentId = Department.Id) T1
WHERE Salary = Department_max_salary AND Department IS NOT NULL
```
##### [**Back to Question List**](#question-list)
[Q184]:
https://leetcode.com/problems/department-highest-salary/

#### [**Q534 Game Play Analysis III**][Q534]
```sql
SELECT player_id, event_date, 
SUM(games_played) OVER (PARTITION BY player_id ORDER BY event_date) AS games_played_so_far
FROM Activity
```
##### [**Back to Question List**](#question-list)
[Q534]:
https://leetcode.com/problems/game-play-analysis-iii/

#### [**Q550 Game Play Analysis IV**][Q550]
```sql
# Solution 1
SELECT ROUND(Consecutive/player_counts,2) AS fraction
FROM
    (SELECT COUNT(T1.player_id) AS Consecutive
     FROM
        (SELECT player_id, event_date,
         MIN(event_date) OVER(PARTITION BY player_id) AS frist_login,
         event_date - MIN(event_date) OVER(PARTITION BY player_id) AS Day_To_Next
         FROM Activity) T1
     WHERE Day_To_Next = 1)T2,
     (SELECT COUNT(DISTINCT player_id) AS player_counts FROM Activity)T3
```

```sql
# Solution 2
SELECT ROUND(COUNT(DISTINCT T2.player_id)/ COUNT( DISTINCT activity.player_id),2) AS fraction
FROM
    (SELECT T1.player_id, (event_date - first_login) AS day_diff
        FROM
        (SELECT player_id, event_date ,MIN(event_date) OVER (PARTITION BY player_id) as first_login FROM activity) T1)T2, activity
WHERE T2.day_diff = 1
```
##### [**Back to Question List**](#question-list)
[Q550]:
https://leetcode.com/problems/game-play-analysis-iv/

#### [**Q570 Managers with at Least 5 Direct Reports**][Q570]
```sql
SELECT Employee.Name
FROM (SELECT ManagerId
     FROM Employee
     GROUP BY ManagerId
     HAVING COUNT(Id) >= 5) T2
LEFT JOIN Employee
ON T2.ManagerId = Employee.Id
WHERE Employee.Name IS NOT NULL
```
##### [**Back to Question List**](#question-list)
[Q570]:
https://leetcode.com/problems/managers-with-at-least-5-direct-reports/

#### [**Q574 Winning Candidate**][Q574]
```sql
SELECT Candidate.Name
FROM Vote
LEFT JOIN Candidate
ON Vote.CandidateId = Candidate.id
GROUP BY Candidate.Name
ORDER BY COUNT(Vote.id) DESC
LIMIT 1
```
##### [**Back to Question List**](#question-list)
[Q574]:
https://leetcode.com/problems/winning-candidate/

#### [**Q578 Get Highest Answer Rate Question**][Q578]
```sql
SELECT question_id AS survey_log
FROM survey_log
GROUP BY question_id
ORDER BY SUM(CASE WHEN action = 'ANSWER' THEN 1 ELSE 0 END)/SUM(CASE WHEN ACTION = 'SHOW' THEN 1 ELSE 0 END) DESC
LIMIT 1
```
##### [**Back to Question List**](#question-list)
[Q578]:
https://leetcode.com/problems/get-highest-answer-rate-question/

#### [**Q580 Count Student Number in Departments**][Q580]
```sql
SELECT dept_name, COALESCE(student_number,0) AS student_number
FROM department
LEFT JOIN
    (SELECT dept_id, COUNT(student_id) AS student_number
     FROM student
     GROUP BY dept_id)T1
ON department.dept_id = T1.dept_id
ORDER BY COALESCE(student_number,0) DESC, dept_name
```
##### [**Back to Question List**](#question-list)
[Q580]:
https://leetcode.com/problems/count-student-number-in-departments/

#### [**Q585 Investments in 2016**][Q585]
```sql
SELECT ROUND(SUM(TIV_2016),2) AS TIV_2016
FROM insurance
WHERE 
    TIV_2015 IN (SELECT TIV_2015
                 FROM insurance
                 GROUP BY TIV_2015
                 HAVING COUNT(PID) > 1)
AND
    LAT IN  (SELECT LAT
             FROM insurance
             GROUP BY LAT, LON
             HAVING COUNT(PID) = 1)
AND
    LON IN  (SELECT LON
             FROM insurance
             GROUP BY LAT, LON
             HAVING COUNT(PID) = 1)
```
##### [**Back to Question List**](#question-list)
[Q585]:
https://leetcode.com/problems/investments-in-2016/

#### [**Q602 Friend Requests II: Who Has the Most Friends**][Q602]
```sql
SELECT id, SUM(friends) AS num
FROM
    (SELECT requester_id AS id, COALESCE(COUNT(requester_id),0) AS friends
     FROM request_accepted
     GROUP BY requester_id
    UNION ALL
     SELECT accepter_id AS id, COALESCE(COUNT(accepter_id),0) AS friends
     FROM request_accepted
     GROUP BY accepter_id) T1
GROUP BY id
ORDER BY num DESC
LIMIT 1
```
##### [**Back to Question List**](#question-list)
[Q602]:
https://leetcode.com/problems/friend-requests-ii-who-has-the-most-friends/

#### [**Q608 Tree Node**][Q608]
```sql
SELECT DISTINCT id AS Id, "Root" AS Type
FROM tree
WHERE p_id IS NULL
UNION ALL
SELECT DISTINCT id AS Id, "Inner" AS Type
FROM tree
WHERE id IN (SELECT DISTINCT p_id FROM tree) AND p_id IS NOT NULL
UNION ALL
SELECT DISTINCT id AS Id, "Leaf" AS Type
FROM tree
WHERE id NOT IN (SELECT DISTINCT p_id FROM tree WHERE p_id IS NOT NULL) AND p_id IS NOT NULL
```
##### [**Back to Question List**](#question-list)
[Q608]:
https://leetcode.com/problems/tree-node/

#### [**Q612 Shortest Distance in a Plane**][Q612]
```sql
SELECT MIN(ROUND(SQRT(POWER(T2X - T1X, 2) + POWER(T2Y - T1Y, 2)), 2)) AS shortest
FROM
    (SELECT T1.x AS T1X, T1.y AS T1Y, T2.x AS T2X, T2.y AS T2Y
     FROM point_2d AS T1
     CROSS JOIN point_2d AS T2)T3
WHERE T2X != T1X OR T2Y != T1Y
```
##### [**Back to Question List**](#question-list)
[Q612]:
https://leetcode.com/problems/shortest-distance-in-a-plane/

#### [**Q614 Second Degree Follower**][Q614]
```sql
SELECT followee AS follower, COUNT(DISTINCT follower) AS num
FROM follow
WHERE followee IN (SELECT DISTINCT follower FROM follow)
GROUP BY followee
ORDER BY followee
```
##### [**Back to Question List**](#question-list)
[Q614]:
https://leetcode.com/problems/second-degree-follower/

#### [**Q626 Exchange Seats**][Q626]
```sql
SELECT id-1 AS id, student
FROM seat
WHERE id%2 = 0
UNION ALL
SELECT id+1 AS id, student
FROM seat
WHERE id != (SELECT MAX(id) FROM seat) AND id%2 = 1
UNION ALL
SELECT id, student
FROM seat
WHERE id = (SELECT MAX(id) FROM seat) AND id%2 = 1
ORDER BY id
```
##### [**Back to Question List**](#question-list)
[Q626]:
https://leetcode.com/problems/exchange-seats/

#### [**Q1045 Customers Who Bought All Products**][Q1045]
```sql
SELECT customer_id
FROM
    (SELECT customer_id, product_key
     FROM Customer
     WHERE product_key IN (SELECT DISTINCT product_key FROM Product))T1
GROUP BY customer_id
HAVING COUNT(DISTINCT product_key) = (SELECT COUNT(DISTINCT product_key) FROM product)
```
##### [**Back to Question List**](#question-list)
[Q1045]:
https://leetcode.com/problems/customers-who-bought-all-products/

#### [**Q1070 Product Sales Analysis III**][Q1070]
```sql
SELECT T1.product_id, T1.first_year, quantity, price
FROM
    (SELECT product_id, MIN(year) AS first_year
     FROM Sales
     GROUP BY product_id) T1
LEFT JOIN Sales
ON T1.product_id = Sales.product_id AND T1.first_year = Sales.year
```
##### [**Back to Question List**](#question-list)
[Q1070]:
https://leetcode.com/problems/product-sales-analysis-iii/

#### [**Q1077 Project Employees III**][Q1077]
```sql
SELECT project_id, employee_id
FROM (SELECT project_id, Employee.employee_id, experience_years, 
      MAX(experience_years) OVER(PARTITION BY project_id) AS project_max_exp
      FROM Project
      LEFT JOIN Employee
      ON Project.employee_id = Employee.employee_id)T1
WHERE T1.experience_years = T1.project_max_exp
```
##### [**Back to Question List**](#question-list)
[Q1077]:
https://leetcode.com/problems/project-employees-iii/

#### [**Q1098 Unpopular Books**][Q1098]
```sql
SELECT T1.book_id, name
FROM 
    (SELECT book_id, name 
     FROM Books
     WHERE available_from < DATE('2019-05-23'))T1
     LEFT JOIN 
    (SELECT book_id, SUM(quantity) AS quantity
     FROM Orders
     WHERE dispatch_date BETWEEN DATE('2018-06-23') AND DATE('2019-06-23')
     GROUP BY book_id)T2
    ON T1.book_id = T2.book_id
WHERE COALESCE(quantity, 0) < 10
```
##### [**Back to Question List**](#question-list)
[Q1098]:
https://leetcode.com/problems/unpopular-books/

#### [**Q1107 New Users Daily Count**][Q1107]
```sql
SELECT first_date AS login_date, COUNT(user_id) AS user_count
FROM
    (SELECT user_id, MIN(activity_date) AS first_date
     FROM Traffic
     WHERE activity = 'login'
     GROUP BY user_id)T1
WHERE first_date BETWEEN DATE_ADD(('2019-06-30'), INTERVAL -90 DAY) AND DATE('2019-06-30')
GROUP BY first_date 
```
##### [**Back to Question List**](#question-list)
[Q1107]:
https://leetcode.com/problems/new-users-daily-count/

#### [**Q1112 Highest Grade For Each Student**][Q1112]
```sql
SELECT student_id, MIN(course_id) AS course_id, grade
FROM
    (SELECT student_id, course_id, grade, 
     MAX(grade) OVER (PARTITION BY student_id) AS highest_grade
     FROM Enrollments)T1
WHERE grade = highest_grade
GROUP BY student_id
ORDER BY student_id
```
##### [**Back to Question List**](#question-list)
[Q1112]:
https://leetcode.com/problems/highest-grade-for-each-student/

#### [**Q1126 Active Businesses**][Q1126]
```sql
SELECT business_id
FROM (SELECT business_id, event_type, occurences, 
      AVG(occurences) OVER(PARTITION BY event_type) AS event_average
      FROM Events) T1
WHERE occurences > event_average
GROUP BY business_id
HAVING COUNT(business_id) > 1
```
##### [**Back to Question List**](#question-list)
[Q1126]:
https://leetcode.com/problems/active-businesses/

#### [**Q1132 Reported Posts II**][Q1132]
```sql
# Solution 1
SELECT ROUND(AVG(rates)*100,2) AS average_daily_percent
FROM
  (SELECT action_date, SUM(removed)/COUNT(post_id) AS rates   
   FROM
    (SELECT DISTINCT action_date,  post_id, 
     CASE
        WHEN post_id IN (SELECT DISTINCT post_id FROM Removals) 
        THEN 1 ELSE 0 END AS removed
     FROM Actions
     WHERE extra = 'spam')T1
   GROUP BY action_date)T2
```

```sql
# Solution 2
SELECT ROUND(AVG(rates)*100,2) AS average_daily_percent
FROM
    (SELECT T1.action_date, COALESCE(T2.removes,0)/T1.spam AS rates 
     FROM
        (SELECT action_date, COUNT(DISTINCT post_id) AS spam
         FROM Actions
         WHERE extra = 'spam'
         GROUP BY action_date)T1
     LEFT JOIN 
        (SELECT action_date, COUNT(DISTINCT Actions.post_id) AS removes
         FROM Actions
         LEFT JOIN Removals
         ON Actions.post_id = Removals.post_id
         WHERE extra = 'spam' AND remove_date IS NOT NULL
         GROUP BY action_date)T2
     ON T1.action_date = T2.action_date)T3
```

```sql
# Solution 3
SELECT ROUND(AVG(COALESCE(removal,0)/COALESCE(spam,0))*100,2) AS average_daily_percent
FROM
        (SELECT action_date, COUNT(DISTINCT post_id) AS removal
         FROM
            (SELECT Actions.post_id, action_date, remove_date
 	         FROM Actions
 	         LEFT JOIN Removals
 	         ON Actions.post_id = Removals.post_id
 	         WHERE extra = 'spam') T1
     	 WHERE remove_date IS NOT NULL
		 GROUP BY action_date)T2

	RIGHT JOIN

    (SELECT action_date, COUNT(DISTINCT post_id) AS spam
     FROM
        (SELECT actions.post_id, action_date, remove_date
 	     FROM Actions
 	     LEFT JOIN Removals
 	     ON Actions.post_id = Removals.post_id
 	     WHERE extra = 'spam') T3
     GROUP BY action_date)T4
	ON T2.action_date = T4.action_date
```
##### [**Back to Question List**](#question-list)
[Q1132]:
https://leetcode.com/problems/reported-posts-ii/

#### [**Q1149 Article Views II**][Q1149]
```sql
SELECT DISTINCT viewer_id AS id
FROM Views
GROUP BY viewer_id, view_date
HAVING COUNT(DISTINCT article_id)  > 1
ORDER BY viewer_id
```
##### [**Back to Question List**](#question-list)
[Q1149]:
https://leetcode.com/problems/article-views-ii/

#### [**Q1158 Market Analysis I**][Q1158]
```sql
SELECT user_id AS buyer_id, join_date, COALESCE(order_count,0) AS orders_in_2019
FROM Users
LEFT JOIN
    (SELECT buyer_id, COUNT(order_id) AS order_count
     FROM Orders
     WHERE order_date BETWEEN DATE('2019-01-01') AND DATE('2019-12-31')
     GROUP BY buyer_id)T1
ON T1.buyer_id = users.user_id
```
##### [**Back to Question List**](#question-list)
[Q1158]:
https://leetcode.com/problems/market-analysis-i/

#### [**Q1164 Product Price at a Given Date**][Q1164]
```sql
SELECT T3.product_id, COALESCE(new_price, 10) AS price
FROM
  (SELECT T1.product_id, T2.latest_change_date
   FROM
    (SELECT DISTINCT product_id FROM Products)T1
     LEFT JOIN
    (SELECT product_id, Max(change_date) AS latest_change_date
     FROM Products
     WHERE change_date <= DATE('2019-08-16')
     GROUP BY product_id)T2
     ON T1.product_id = T2.product_id)T3
   LEFT JOIN Products
   ON T3.product_id = Products.product_id AND T3.latest_change_date = Products.change_date
```
##### [**Back to Question List**](#question-list)
[Q1164]:
https://leetcode.com/problems/product-price-at-a-given-date/

#### [**Q1174 Immediate Food Delivery II**][Q1174]
```sql
SELECT ROUND(SUM(immediate)/COUNT(delivery_id)*100,2) AS immediate_percentage
FROM
    (SELECT Delivery.delivery_id, T1.first_order, Delivery.customer_pref_delivery_date,
     CASE T1.first_order WHEN Delivery.customer_pref_delivery_date THEN 1 ELSE 0 END AS immediate
     FROM
        (SELECT customer_id, MIN(order_date) AS first_order
         FROM Delivery
         GROUP BY customer_id)T1
         LEFT JOIN Delivery
         ON T1.customer_id = Delivery.customer_id AND T1.first_order = Delivery.order_date)T2
```
##### [**Back to Question List**](#question-list)
[Q1174]:
https://leetcode.com/problems/immediate-food-delivery-ii/

#### [**Q1193 Monthly Transactions I**][Q1193]
```sql
WITH Transaction_table (id, country, approved, amount, month) 
    AS( SELECT id, country, 
               CASE state WHEN "approved" THEN 1 ELSE 0 END AS approved,
               amount, DATE_FORMAT(trans_date, '%Y-%m') AS month
        FROM Transactions)
      
SELECT T1.month, T1.country, trans_count, approved_count, trans_total_amount, COALESCE(approved_total_amount,0) AS approved_total_amount
FROM
    (SELECT month, country, COUNT(id) AS trans_count, SUM(approved) AS approved_count, SUM(amount) AS trans_total_amount
     FROM transaction_table
     GROUP BY month, country)T1
LEFT JOIN
    (SELECT month, country, SUM(amount) AS approved_total_amount
     FROM transaction_table
     WHERE approved = 1
     GROUP BY month, country)T2
ON T1.month = T2.month AND T1.country = T2.country
```
##### [**Back to Question List**](#question-list)
[Q1193]:
https://leetcode.com/problems/monthly-transactions-i/

#### [**Q1204 Last Person to Fit in the Elevator**][Q1204]
```sql
SELECT person_name
FROM
    (SELECT SUM(weight) OVER(ORDER BY turn) AS tot_weight, turn, person_name
     FROM Queue)T1
WHERE tot_weight <= 1000
ORDER BY turn DESC
LIMIT 1
```
##### [**Back to Question List**](#question-list)
[Q1204]:
https://leetcode.com/problems/last-person-to-fit-in-the-elevator/

#### [**Q1205 Monthly Transactions II**][Q1205]
```sql
WITH Tot_trans (id, country, approved, amount, trans_month, chargeback_month, charge_backs) AS 
    (SELECT id, country, approved, amount, trans_month, chargeback_month,
       CASE WHEN chargeback_month IS NULL THEN 0 ELSE 1 END AS charge_backs
     FROM
        (SELECT id, country, 
         CASE state WHEN 'approved' THEN 1 ELSE 0 END AS approved, amount,
         DATE_FORMAT(trans_date, '%Y-%m') AS trans_month
         FROM Transactions)T1
     LEFT JOIN
        (SELECT trans_id, DATE_FORMAT(trans_date,'%Y-%m') AS chargeback_month
         FROM Chargebacks)T2
     ON T1.id = T2.trans_id),
     T3 (month, country, approved_count, approved_amount) AS
     (SELECT trans_month AS month, country, SUM(approved) AS approved_count,
     SUM(amount) AS approved_amount
     FROM Tot_trans
     WHERE approved = 1
     GROUP BY trans_month, country),
     T4 (month, country, chargeback_count, chargeback_amount) AS
     (SELECT chargeback_month AS month, country, 
     SUM(charge_backs) AS chargeback_count, SUM(amount) AS chargeback_amount
     FROM Tot_trans
     WHERE charge_backs = 1
     GROUP BY chargeback_month, country)

SELECT *
FROM
    (SELECT T3.month, T3.country, COALESCE(approved_count,0) AS
     approved_count, COALESCE(approved_amount,0) AS approved_amount,
     COALESCE(chargeback_count,0) AS chargeback_count,
     COALESCE(chargeback_amount,0) AS chargeback_amount
     FROM T3 LEFT JOIN T4
     ON T3.month = T4.month AND T3.country = T4.country
     UNION
     SELECT T4.month, T4.country, COALESCE(approved_count,0) AS
     approved_count, COALESCE(approved_amount,0) AS approved_amount,
     COALESCE(chargeback_count,0) AS chargeback_count,
     COALESCE(chargeback_amount,0) AS chargeback_amount
     FROM T3 RIGHT JOIN T4
     ON T3.month = T4.month AND T3.country = T4.country)T5
WHERE approved_count != 0 OR approved_amount != 0 OR chargeback_count != 0 OR chargeback_amount != 0
```
##### [**Back to Question List**](#question-list)
[Q1205]:
https://leetcode.com/problems/monthly-transactions-ii/

#### [**Q1212 Team Scores in Football Tournament**][Q1212]
```sql
WITH Points (match_id,host_team, guest_team, host_points, guest_points ) AS(
    SELECT match_id ,host_team, guest_team, 
       CASE 
        WHEN host_goals > guest_goals THEN 3
        WHEN host_goals = guest_goals THEN 1
        ELSE 0 END AS host_points,
       CASE
        WHEN guest_goals > host_goals THEN 3
        WHEN guest_goals = host_goals THEN 1
        ELSE 0 END AS guest_points
    FROM Matches)
    
SELECT Teams.team_id, Team_name, COALESCE(SUM(num_points),0) AS num_points
FROM Teams
LEFT JOIN
    (SELECT host_team AS team_id, SUM(host_points) AS num_points
     FROM Points
     GROUP BY host_team
     UNION ALL
     SELECT guest_team AS team_id, SUM(guest_points) AS num_point
     FROM Points
     GROUP BY guest_team)T1
ON Teams.team_id = T1.team_id
GROUP BY team_id
ORDER BY COALESCE(SUM(num_points),0) DESC, team_id
```
##### [**Back to Question List**](#question-list)
[Q1212]:
https://leetcode.com/problems/team-scores-in-football-tournament/

#### [**Q1264 Page Recommendations**][Q1264]
```sql
SELECT page_id AS recommended_page
FROM
    (SELECT DISTINCT page_id
     FROM Likes
     WHERE user_id IN 
        (SELECT user2_id
         FROM Friendship
         WHERE user1_id = 1
         UNION
         SELECT user1_id
         FROM Friendship
         WHERE user2_id =1))T1
WHERE page_id NOT IN
    (SELECT DISTINCT page_id
     FROM Likes
     WHERE user_id = 1)
```
##### [**Back to Question List**](#question-list)
[Q1264]:
https://leetcode.com/problems/page-recommendations/

#### [**Q1270 All People Report to the Given Manager**][Q1270]
```sql
SELECT DISTINCT employee_id
FROM Employees
WHERE manager_id = 1 AND employee_id !=1
OR 
manager_id IN
    (SELECT employee_id
     FROM Employees
     WHERE manager_id = 1 AND employee_id != 1)
OR manager_id IN 
    (SELECT employee_id
     FROM Employees
     WHERE manager_id IN
        (SELECT employee_id
         FROM Employees
         WHERE manager_id = 1 AND employee_id != 1))
```
##### [**Back to Question List**](#question-list)
[Q1270]:
https://leetcode.com/problems/all-people-report-to-the-given-manager/

#### [**Q1285 Find the Start and End Number of Continuous Ranges**][Q1285]
```sql
WITH Diff (log_id, last_log_id, last_diff, next_log_id, next_diff, start_id, end_id)
AS 
    (SELECT log_id, LAG(log_id, 1) OVER() AS last_log_id, log_id - LAG(log_id, 1) OVER() AS last_diff, 
            LEAD(log_id, 1) OVER() AS next_log_id, log_id - LEAD(log_id, 1) OVER() AS next_diff,
            CASE WHEN log_id - LAG(log_id, 1) OVER() != 1 THEN "yes"
                 WHEN log_id - LAG(log_id, 1) OVER() IS NULL THEN "yes" 
                 ELSE "no" END AS start_id,
            CASE WHEN log_id - LEAD(log_id, 1) OVER() != -1 THEN "yes"
                 WHEN log_id - LEAD(log_id, 1) OVER() IS NULL THEN "yes"   
                 ELSE "no" END AS end_id
    FROM Logs)

SELECT T1.log_id AS start_id, T2.log_id AS end_id
FROM
    (SELECT ROW_NUMBER() OVER() AS row_num, log_id
     FROM Diff
     WHERE start_id = "yes") T1
    LEFT JOIN 
    (SELECT ROW_NUMBER() OVER() AS row_num, log_id
     FROM Diff
     WHERE end_id = "yes") T2
    ON T1.row_num = T2.row_num
```
##### [**Back to Question List**](#question-list)
[Q1285]:
https://leetcode.com/problems/find-the-start-and-end-number-of-continuous-ranges/

#### [**Q1308 Running Total for Different Genders**][Q1308]
```sql
SELECT gender, day, SUM(score_points) OVER (PARTITION BY gender ORDER BY day) AS total
FROM Scores
```
##### [**Back to Question List**](#question-list)
[Q1308]:
https://leetcode.com/problems/running-total-for-different-genders/

#### [**Q1321 Restaurant Growth**][Q1321]
```sql
SELECT visited_on, amount, ROUND(amount/7,2) AS average_amount
FROM
    (SELECT visited_on, current_amount +
                   LAG(current_amount,1) OVER(ORDER BY visited_on)+
                   LAG(current_amount,2) OVER(ORDER BY visited_on)+
                   LAG(current_amount,3) OVER(ORDER BY visited_on)+
                   LAG(current_amount,4) OVER(ORDER BY visited_on)+
                   LAG(current_amount,5) OVER(ORDER BY visited_on)+
                   LAG(current_amount,6) OVER(ORDER BY visited_on) AS amount             
    FROM
        (SELECT visited_on, SUM(amount) AS current_amount
         FROM Customer
         GROUP BY visited_on)T1)T2
WHERE amount IS NOT NULL
```
##### [**Back to Question List**](#question-list)
[Q1321]:
https://leetcode.com/problems/restaurant-growth/

#### [**Q1341 Movie Rating**][Q1341]
```sql
(SELECT name AS results
 FROM
 (SELECT user_id, COUNT(movie_id) AS movie_rated
  FROM Movie_Rating
  GROUP BY user_id)T1
 LEFT JOIN Users
 ON T1.user_id = Users.user_id
 ORDER BY movie_rated DESC, name
 LIMIT 1)

UNION

(SELECT title
 FROM
 (SELECT movie_id, AVG(rating) AS avg_rating
  FROM Movie_Rating
  WHERE created_at BETWEEN DATE('2020-02-01') AND DATE('2020-02-29')
  GROUP BY movie_id)T2
 LEFT JOIN Movies
 ON T2.movie_id = Movies.movie_id
 ORDER BY avg_rating DESC, title
 LIMIT 1)
 ```
##### [**Back to Question List**](#question-list)
[Q1341]:
https://leetcode.com/problems/movie-rating/

#### [**Q1355 Activity Participants**][Q1355]
```sql
WITH Activity (activity, participants) AS
(SELECT activity, COUNT(id) AS participants
 FROM Friends
 GROUP BY activity)
 
SELECT activity
FROM Activity
WHERE 
    participants > (SELECT MIN(participants) FROM Activity) 
    AND 
    participants < (SELECT MAX(participants) FROM Activity)
```
##### [**Back to Question List**](#question-list)
[Q1355]:
https://leetcode.com/problems/activity-participants/

#### [**Q1364 Number of Trusted Contacts of a Customer**][Q1364]
```sql
SELECT invoice_id, customer_name, price,COALESCE(contact_cnt,0) AS contacts_cnt, COALESCE(trusted_contacts_cnt,0) AS trusted_contacts_cnt
FROM Invoices
LEFT JOIN
   (SELECT customer_id, customer_name, contact_cnt, trusted_contacts_cnt
    FROM
        (SELECT customer_id, customer_name, contact_cnt
         FROM Customers
         LEFT JOIN
        (SELECT user_id, COUNT(contact_name) AS contact_cnt
         FROM Contacts
         GROUP BY user_id)T1
        ON Customers.customer_id = T1.user_id)T2
    LEFT JOIN 
        (SELECT user_id, COUNT(contact_name) AS trusted_contacts_cnt
         FROM Contacts
         WHERE contact_name IN (SELECT DISTINCT customer_name FROM Customers)
         GROUP BY user_id)T3
    ON T2.customer_id = T3.user_id)T4
ON Invoices.user_id = T4.customer_id
ORDER BY invoice_id
```
##### [**Back to Question List**](#question-list)
[Q1364]:
https://leetcode.com/problems/number-of-trusted-contacts-of-a-customer/

#### [**Q1393 Capital Gain/Loss**][Q1393]
```sql
SELECT stock_name, SUM(gain) AS capital_gain_loss
FROM
    (SELECT stock_name, operation, operation_day, 
       CASE operation 
       WHEN "Buy" THEN price*-1 
       WHEN "Sell" THEN price END AS gain
     FROM Stocks)T1
GROUP BY stock_name
```
##### [**Back to Question List**](#question-list)
[Q1393]:
https://leetcode.com/problems/capital-gainloss/

#### [**Q1398 Customers Who Bought Products A and B but Not C**][Q1398]
```sql
SELECT customer_id, customer_name
FROM Customers
WHERE customer_id IN
    (SELECT DISTINCT customer_id AS A_buyer
     FROM Orders
     WHERE product_name = "A") 
     AND
     customer_id IN 
     (SELECT DISTINCT customer_id AS A_buyer
     FROM Orders
     WHERE product_name = "B")
     AND
     customer_id NOT IN
     (SELECT DISTINCT customer_id AS A_buyer
     FROM Orders
     WHERE product_name = "C") 
```
##### [**Back to Question List**](#question-list)
[Q1398]:
https://leetcode.com/problems/customers-who-bought-products-a-and-b-but-not-c/

#### [**Q1421 NPV Queries**][Q1421]
```sql
SELECT Queries.id, Queries.year, COALESCE(npv,0) AS npv
FROM Queries
LEFT JOIN NPV
ON Queries.id = NPV.id AND Queries.year = NPV.year
ORDER BY Queries.id
```
##### [**Back to Question List**](#question-list)
[Q1421]:
https://leetcode.com/problems/npv-queries/

#### [**Q1440 Evaluate Boolean Expression**][Q1440]
```sql
WITH 
Expression (ROW_ID, left_operand, operator, right_operand) AS
(SELECT ROW_NUMBER()OVER(ORDER BY left_operand) AS row_id,
 left_operand, operator, right_operand FROM Expressions),

New_form (row_id, left_value, left_operand, operator, right_value, right_operand, diff) AS
(SELECT T1.row_id, left_value, left_operand, operator, right_value, right_operand, left_value - right_value
 FROM
    (SELECT row_id, left_operand, value AS left_value, operator
     FROM Expression
     LEFT JOIN Variables
     ON Expression.left_operand = Variables.name)T1
 LEFT JOIN 
    (SELECT row_id, right_operand, value AS right_value
     FROM Expression
     LEFT JOIN Variables
     ON Expression.right_operand = Variables.name)T2
 ON T1.row_id = T2.row_id)
 
SELECT left_operand, operator, right_operand, 
CASE 
    WHEN diff > 0 AND operator = ">" THEN "true"
    WHEN diff = 0 AND operator = "=" THEN "true"
    WHEN diff < 0 AND operator = "<" THEN "true"
    ELSE "false" END AS value
FROM New_form
```
##### [**Back to Question List**](#question-list)
[Q1440]:
https://leetcode.com/problems/evaluate-boolean-expression/

#### [**Q1445 Apples and Oranges**][Q1445]
```sql
SELECT Sales_dates.sale_date, apple_sold - orange_sold AS diff
FROM
    (SELECT DISTINCT sale_date
     FROM Sales) Sales_dates
    LEFT JOIN 
    (SELECT sale_date, SUM(sold_num) AS apple_sold
     FROM Sales
     WHERE fruit = 'apples'
     GROUP BY sale_date) Apple
    ON Sales_dates.sale_date = Apple.sale_date
    LEFT JOIN 
    (SELECT sale_date, SUM(sold_num) AS orange_sold
    FROM Sales
    WHERE fruit = 'oranges'
    GROUP BY sale_date) Orange
    ON Apple.sale_date = Orange.sale_date
```
##### [**Back to Question List**](#question-list)
[Q1445]:
https://leetcode.com/problems/apples-oranges/

#### [**Q1454 Active Users**][Q1454]
```sql
SELECT DISTINCT T2.id, name
FROM
    (SELECT id,
     LEAD(login_date, 4) OVER (PARTITION BY id ORDER BY login_date) AS next_4th_login,
     DATE_ADD(login_date, INTERVAL 4 DAY) AS next_4_day
     FROM
        (SELECT DISTINCT id, login_date
         FROM Logins)T1)T2
LEFT JOIN Accounts
ON T2.id = Accounts.id
WHERE next_4th_login = next_4_day
ORDER BY T2.id
```
##### [**Back to Question List**](#question-list)
[Q1454]:
https://leetcode.com/problems/active-users/

#### [**Q1459 Rectangles Area**][Q1459]
```sql
SELECT P1.id AS p1, P2.id AS p2, 
    ABS(P1.x_value - P2.x_value) * ABS(P1.y_value - P2.y_value) AS area
FROM Points AS P1, Points AS P2
WHERE P1.id < P2.id 
  AND ABS(P1.x_value - P2.x_value) * ABS(P1.y_value - P2.y_value) != 0
ORDER BY ABS(P1.x_value - P2.x_value) * ABS(P1.y_value - P2.y_value) DESC, P1.id, P2.id
```
##### [**Back to Question List**](#question-list)
[Q1459]:
https://leetcode.com/problems/rectangles-area/

#### [**Q1468 Calculate Salaries**][Q1468]
```sql
WITH rate (company_id, employee_id, employee_name, company_max, origin_salary)
AS (SELECT company_id, employee_id, employee_name, 
       MAX(salary) OVER(PARTITION BY company_id) AS company_max, salary
    FROM Salaries)
    
SELECT company_id, employee_id, employee_name, 
       CASE
        WHEN company_max < 1000 THEN origin_salary
        WHEN company_max BETWEEN 1000 AND 10000 THEN ROUND((1-0.24)*origin_salary,0)
        ELSE ROUND((1-0.49)*origin_salary,0) END AS salary
FROM rate
```
##### [**Back to Question List**](#question-list)
[Q1468]:
https://leetcode.com/problems/calculate-salaries/

#### [**Q1468 Calculate Salaries**][Q1468]
```sql
WITH rate (company_id, employee_id, employee_name, company_max, origin_salary)
AS (SELECT company_id, employee_id, employee_name, 
       MAX(salary) OVER(PARTITION BY company_id) AS company_max, salary
    FROM Salaries)
    
SELECT company_id, employee_id, employee_name, 
       CASE
        WHEN company_max < 1000 THEN origin_salary
        WHEN company_max BETWEEN 1000 AND 10000 THEN ROUND((1-0.24)*origin_salary,0)
        ELSE ROUND((1-0.49)*origin_salary,0) END AS salary
FROM rate
```
##### [**Back to Question List**](#question-list)
[Q1468]:
https://leetcode.com/problems/calculate-salaries/

#### [**Q1501 Countries You Can Safely Invest In**][Q1501]
```sql
# Solution 1
WITH 
Persons AS
(SELECT SUBSTRING_INDEX(phone_number,"-",1) AS country_code, id, name, phone_number FROM Person), 

Person_country AS 
(SELECT id, Persons.name, phone_number, Country.name AS country
 FROM Persons
 LEFT JOIN Country
 ON Persons.country_code = Country.country_code)

SELECT country
FROM(
    SELECT country, AVG(duration) AS country_duration
    FROM
        (SELECT country, duration
         FROM Calls
         LEFT JOIN Person_country
         ON Calls.caller_id = Person_country.id
         UNION ALL
         SELECT country, duration
         FROM Calls
         LEFT JOIN Person_country
         ON Calls.callee_id = Person_country.id)T1
    GROUP BY country)T2
WHERE country_duration > (SELECT AVG(duration) FROM Calls)
```

```sql
# Solution 2
WITH duration AS 
    (SELECT caller_id AS id, duration FROM Calls
     UNION ALL
     SELECT callee_id AS id, duration FROM Calls),
     persons AS(
     SELECT id, SUBSTRING_INDEX(phone_number, '-', 1) AS country_code
     FROM person)
    
SELECT DISTINCT country
FROM    
   (SELECT country, AVG(duration) OVER (PARTITION BY country) AS country_avg,
    AVG(duration) OVER(PARTITION BY NULL) AS global_avg
    FROM duration
    LEFT JOIN
    (SELECT id, Country.name AS country
    FROM persons LEFT JOIN Country
    ON persons.country_code = Country.country_code)T1
    ON duration.id = T1.id)T2
WHERE country_avg > global_avg
```

##### [**Back to Question List**](#question-list)
[Q1501]:
https://leetcode.com/problems/countries-you-can-safely-invest-in/

#### [**Q1532 The Most Recent Three Orders**][Q1532]
```sql
SELECT name AS customer_name, T1.customer_id, order_id, order_date
FROM
    (SELECT order_id, order_date, customer_id, 
       RANK() OVER (PARTITION BY customer_id ORDER BY order_date DESC) AS order_counts
     FROM Orders)T1
LEFT JOIN Customers
ON T1.Customer_id = Customers.customer_id
WHERE order_counts <=3
ORDER BY namE, T1.customer_id, order_date DESC
```
##### [**Back to Question List**](#question-list)
[Q1532]:
https://leetcode.com/problems/the-most-recent-three-orders/

#### [**Q185 Department Top Three Salaries**][Q185]
```sql
SELECT Department.Name AS Department, T1.Name AS Employee, Salary
FROM Department
LEFT JOIN
    (SELECT DepartmentId, Name, Salary, 
     DENSE_RANK() OVER (PARTITION BY DepartmentId ORDER BY Salary DESC) AS department_rank
     FROM Employee)T1 
ON T1.DepartmentId = Department.id
WHERE department_rank <=3
```
##### [**Back to Question List**](#question-list)
[Q185]:
https://leetcode.com/problems/department-top-three-salaries/

#### [**Q262 Trips and Users**][Q262]
```sql
SELECT T2.Request_at AS Day, ROUND(COALESCE(cancelled/tot,0),2) AS "Cancellation Rate"
FROM
    (SELECT COUNT(Id) AS cancelled, Request_at
     FROM Trips
     WHERE Client_Id IN (SELECT Users_Id FROM Users WHERE Banned = "No")
    AND   Driver_Id IN (SELECT Users_Id FROM Users WHERE Banned = "No")
    AND Request_at BETWEEN DATE('2013-10-01') AND DATE('2013-10-03')
    AND Status != "completed"
    GROUP BY Request_at)T1
RIGHT JOIN
    (SELECT COUNT(Id) AS tot, Request_at
     FROM Trips
     WHERE Client_Id IN (SELECT Users_Id FROM Users WHERE Banned = "No")
     AND   Driver_Id IN (SELECT Users_Id FROM Users WHERE Banned = "No")
     AND Request_at BETWEEN DATE('2013-10-01') AND DATE('2013-10-03')
     GROUP BY Request_at)T2
ON T1.Request_at = T2.Request_at
```
##### [**Back to Question List**](#question-list)
[Q262]:
https://leetcode.com/problems/trips-and-users/

#### [**Q569 Median Employee Salary**][Q569]
```sql
SELECT Id, T1.Company, Salary
FROM
    (SELECT Id, Company, Salary,
       RANK() OVER(PARTITION BY Company ORDER BY Salary) AS Salary_Rank
     FROM Employee)T1
LEFT JOIN
    (SELECT Company, COUNT(Id)/2 AS Median_Rank
     FROM Employee
     GROUP BY Company)T2
ON T1.Company = T2.Company
WHERE Median_Rank = Salary_Rank OR Median_Rank + 1 = Salary_Rank

UNION ALL

SELECT MIN(T3.Id), T3.Company, Salary
FROM
    (SELECT Id, Company, Salary,
     RANK() OVER(PARTITION BY Company ORDER BY Salary) AS Salary_Rank
     FROM Employee)T3
LEFT JOIN
    (SELECT Company, COUNT(Id)/2+0.5 AS Median_Rank
     FROM Employee
     GROUP BY Company)T4
ON T3.Company = T4.Company 
WHERE T3.Salary_Rank = T4.Median_Rank 
GROUP BY T3.Company, Salary
```
##### [**Back to Question List**](#question-list)
[Q569]:
https://leetcode.com/problems/median-employee-salary/

#### [**Q571 Find Median Given Frequency of Numbers**][Q571]
```sql
WITH Total AS(    
    SELECT Number,
       SUM(Frequency) OVER(ORDER BY Number) - Frequency + 1 AS Start_Row,
       SUM(Frequency) OVER(ORDER BY Number) AS End_Row,
       SUM(Frequency) OVER(PARTITION BY NULL) AS Total_Numbers
    FROM Numbers),
    Median AS(
    SELECT DISTINCT
        CASE Total_Numbers%2 
        WHEN 0 THEN Total_Numbers/2 
            ELSE Total_Numbers/2+0.5 END AS Median_low,
        CASE Total_Numbers%2
        WHEN 0 THEN Total_Numbers/2+1 
            ELSE Total_Numbers/2+0.5 END AS Median_high
    FROM Total)
    
SELECT AVG(Number) AS median
FROM
(
    SELECT Number, Start_Row, End_Row
    FROM Total
    WHERE Start_Row <= (SELECT Median_low FROM Median) 
    AND End_Row >= (SELECT Median_low FROM Median)

    UNION ALL

    SELECT Number, Start_Row, End_Row
    FROM Total
    WHERE Start_Row <= (SELECT Median_high FROM Median) 
    AND End_Row >= (SELECT Median_high FROM Median)
) T1
```
##### [**Back to Question List**](#question-list)
[Q571]:
https://leetcode.com/problems/find-median-given-frequency-of-numbers/

#### [**Q579 Find Cumulative Salary of an Employee**][Q579]
```sql
# Solution 1
WITH T1 AS
(SELECT Id, Month, Salary,
        MAX(Month) OVER (PARTITION BY Id ORDER BY month DESC) AS most_rec_month
 FROM Employee),
 T2 AS
 (SELECT Id, Month, 
  Salary, COALESCE(LEAD(Salary,1) OVER (PARTITION BY id ORDER BY month DESC),0) AS Next_mon,
  COALESCE(LEAD(Salary,2) OVER (PARTITION BY id ORDER BY month DESC),0) AS Next_2_mon
  FROM T1 WHERE Month != most_rec_month)
  
SELECT id, Month, Salary + Next_mon + Next_2_mon AS Salary FROM T2
```

```sql
# Solution 2
"SELECT Id, Month, SUM(Salary) OVER(PARTITION BY Id ORDER BY Month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS Salary
FROM
    (SELECT Id, Month, Salary,
            MAX(Month) OVER(PARTITION BY Id) AS recent_mon
     FROM Employee) T1
WHERE Month != recent_mon
ORDER BY Id, Month DESC"
```
##### [**Back to Question List**](#question-list)
[Q579]:
https://leetcode.com/problems/find-cumulative-salary-of-an-employee/

#### [**Q601 Human Traffic of Stadium**][Q601]
```sql
# Solution 1
SELECT DISTINCT id, visit_date, people
FROM stadium
WHERE id IN 
    (SELECT id
     FROM(
        SELECT id, visit_date, people, 
               LEAD(people,1) OVER (ORDER BY id) AS next_people,
               LEAD(people, 2) OVER (ORDER BY id) AS next_people_2
        FROM stadium)T1
     WHERE people >= 100 AND next_people >= 100 AND next_people_2 >= 100
     
     UNION
     
     SELECT id+1
     FROM(
        SELECT id, visit_date, people, 
               LEAD(people,1) OVER (ORDER BY id) AS next_people,
               LEAD(people, 2) OVER (ORDER BY id) AS next_people_2
        FROM stadium)T1
     WHERE people >= 100 AND next_people >= 100 AND next_people_2 >= 100
     
     UNION
     
     SELECT id+2
     FROM(
        SELECT id, visit_date, people, 
               LEAD(people,1) OVER (ORDER BY id) AS next_people,
               LEAD(people, 2) OVER (ORDER BY id) AS next_people_2
        FROM stadium)T1
     WHERE people >= 100 AND next_people >= 100 AND next_people_2 >= 100)
```

```sql
# Solutio 2
WITH visit_date AS(
SELECT visit_date, last_date, next_date
FROM
    (SELECT visit_date, people,
       LEAD(people,1) OVER (ORDER BY visit_date) AS next_people,
       LAG(people, 1) OVER (ORDER BY visit_date) AS last_people,
       LEAD(visit_date,1) OVER (ORDER BY visit_date) AS next_date,
       LAG(visit_date, 1) OVER (ORDER BY visit_date) AS last_date
     FROM stadium)T1
WHERE people >= 100 AND next_people >= 100 AND last_people >= 100)

SELECT id, visit_date, people 
FROM
    (SELECT id, visit_date, people
     FROM stadium
     WHERE visit_date IN (SELECT visit_date FROM visit_date)
     UNION
     SELECT id, visit_date, people
     FROM stadium
     WHERE visit_date IN (SELECT next_date FROM visit_date)
     UNION
     SELECT id, visit_date, people
     FROM stadium
     WHERE visit_date IN (SELECT last_date FROM visit_date))T2
ORDER BY id
```
##### [**Back to Question List**](#question-list)
[Q601]:
https://leetcode.com/problems/human-traffic-of-stadium/

#### [**Q615 Average Salary: Departments VS Company**][Q615]
```sql
WITH tot_salary AS(
SELECT id, department_id, amount, LEFT(pay_date, 7) AS pay_month
FROM salary LEFT JOIN employee
ON salary.employee_id = employee.employee_id)

SELECT pay_month, department_id, CASE 
WHEN department_mth_avg > company_mth_avg THEN 'higher'
WHEN department_mth_avg = company_mth_avg THEN 'same'
WHEN department_mth_avg < company_mth_avg THEN 'lower' END AS comparison
FROM
    (SELECT DISTINCT pay_month, department_id, 
     AVG(amount) OVER(PARTITION BY department_id, pay_month) AS department_mth_avg,
     AVG(amount) OVER(PARTITION BY pay_month) AS company_mth_avg
    FROM tot_salary)T1
```
##### [**Back to Question List**](#question-list)
[Q615]:
https://leetcode.com/problems/average-salary-departments-vs-company/

#### [**Q618 Students Report By Geography**][Q618]
```sql
# Solution 1
WITH 
America AS(
SELECT name, ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY Name) AS row_num
FROM student
WHERE continent = 'America'),
Europe AS(
SELECT name, ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY Name) AS row_num
FROM student
WHERE continent = 'Europe'),
Asia AS(
SELECT name, ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY Name) AS row_num
FROM student
WHERE continent = 'Asia')


SELECT America.name AS America, Asia.name AS Asia, Europe.name AS Europe
FROM America 
LEFT JOIN Asia
ON America.row_num = ASIA.row_num
LEFT JOIN Europe 
ON America.row_num = Europe.row_num
```

```sql
# Solution 2
SELECT
        MAX(CASE WHEN continent = 'America' THEN name END )AS America,
        MAX(CASE WHEN continent = 'Asia' THEN name END )AS Asia,
        MAX(CASE WHEN continent = 'Europe' THEN name END )AS Europe  
FROM (SELECT *, ROW_NUMBER()OVER(PARTITION BY continent ORDER BY name) AS row_id FROM student) AS t
GROUP BY row_id
```
##### [**Back to Question List**](#question-list)
[Q618]:
https://leetcode.com/problems/students-report-by-geography/

#### [**Q1097 Game Play Analysis V**][Q1097]
```sql
WITH installment AS(
    SELECT player_id, event_date,
           MIN(event_date) OVER (PARTITION BY player_id) AS install_dt,
           DATE_ADD(MIN(event_date) OVER (PARTITION BY player_id), INTERVAL 1 DAY) AS next_day
    FROM Activity)
    
    
SELECT install_dt, SUM(install_cnt) AS installs, ROUND(SUM(next_cnt) / SUM(install_cnt), 2) AS Day1_retention   
FROM
   (SELECT install_dt, 
       CASE event_date WHEN install_dt THEN 1 ELSE 0 END AS install_cnt,
       CASE event_date WHEN next_day THEN 1 ELSE 0 END AS next_cnt
    FROM installment)T1
GROUP BY install_dt
ORDER BY install_dt
```
##### [**Back to Question List**](#question-list)
[Q1097]:
https://leetcode.com/problems/game-play-analysis-v/

#### [**Q1127 User Purchase Platform**][Q1127]
```sql
WITH platform AS (
SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending
UNION ALL
SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending
UNION ALL
SELECT DISTINCT spend_date, 'both' AS platform FROM Spending),

spending_2 AS(
SELECT user_id, spend_date, platform, amount,
    COUNT(platform) OVER(PARTITION BY user_id, spend_date) AS platform_cnt
FROM spending)


SELECT platform.spend_date AS spend_date, platform.platform AS platform, COALESCE(total_amount,0)AS total_amount, COALESCE(total_users,0) AS total_users
FROM platform LEFT JOIN
   (SELECT spend_date, new_platform AS platform, SUM(amount) AS total_amount,
            COALESCE(COUNT(DISTINCT user_id),0) AS total_users
    FROM
        (SELECT spend_date, amount, user_id,
         CASE platform_cnt 
         WHEN 1 THEN platform ELSE 'both' END AS new_platform
         FROM spending_2)T1
    GROUP BY spend_date, new_platform)T2
ON platform.spend_date = T2.spend_date AND platform.platform = T2.platform
```
##### [**Back to Question List**](#question-list)
[Q1127]:
https://leetcode.com/problems/user-purchase-platform/

#### [**Q1159 Market Analysis II**][Q1159]
```sql
WITH seller AS(
    SELECT seller_id, order_date, item_brand
    FROM Orders LEFT JOIN Users
    ON Orders.seller_id = Users.user_id
    LEFT JOIN Items
    ON Orders.item_id = Items.item_id
    ORDER BY seller_id, order_date),
    
    num_item AS(
    SELECT seller_id, ROW_NUMBER() OVER (PARTITION BY seller_id ORDER BY order_date) AS num_item_sold, item_brand
    FROM seller)


SELECT user_id AS seller_id, 
CASE Users.favorite_brand WHEN item_brand THEN 'yes' 
ELSE 'no' END AS 2nd_item_fav_brand   
FROM Users
LEFT JOIN 
    (SELECT seller_id, item_brand
     FROM num_item
     WHERE num_item_sold = 2)T1
ON Users.user_id = T1.seller_id
```
##### [**Back to Question List**](#question-list)
[Q1159]:
https://leetcode.com/problems/market-analysis-ii/

#### [**Q1194 Tournament Winners**][Q1194]
```sql
WITH score AS
(SELECT group_id, player_id, tot_score, MAX(tot_score) OVER(PARTITION  BY group_id) AS group_max_score
 FROM Players LEFT JOIN
   (SELECT player, SUM(score) AS tot_score
    FROM
        (SELECT first_player AS player, SUM(first_score) AS score
         FROM Matches
         GROUP BY first_player

         UNION ALL

         SELECT second_player, SUM(second_score)
         FROM Matches
         GROUP BY second_player)T1
    GROUP BY player)T2
 ON Players.player_id = T2.player)

SELECT group_id, player_id
FROM
   (SELECT group_id, player_id, ROW_NUMBER() OVER(PARTITION BY group_id ORDER BY player_id) AS small_id
    FROM score
    WHERE tot_score = group_max_score)T3
WHERE small_id = 1
```
##### [**Back to Question List**](#question-list)
[Q1194]:
https://leetcode.com/problems/tournament-winners/

#### [**Q1225 Report Contiguous Dates**][Q1225]
```sql
WITH period_state AS(
    SELECT fail_date AS date, "failed" AS period_state, 
           DATEDIFF(fail_date, LAG(fail_date,1) OVER (ORDER BY fail_date)) AS days_to_last, 
           DATEDIFF(LEAD(fail_date,1) OVER(ORDER BY fail_date), fail_date) AS days_to_next
    FROM Failed
    WHERE fail_date >= DATE('2019-01-01') AND fail_date <= DATE('2019-12-31')
    UNION ALL
    SELECT success_date AS date, "succeeded" AS period_state, 
           DATEDIFF(success_date, LAG(success_date,1) OVER (ORDER BY success_date)) AS days_to_last, 
           DATEDIFF(LEAD(success_date,1) OVER(ORDER BY success_date), success_date) AS days_to_next
    FROM Succeeded
    WHERE success_date >= DATE('2019-01-01') AND success_date <= DATE('2019-12-31'))


SELECT period_state, start_date, end_date
FROM(
    
SELECT period_state, start_date, end_date
FROM
    (
    SELECT period_state, date, start_date, ROW_NUMBER() OVER(ORDER BY date) AS row_num
     FROM
        (SELECT date, period_state, days_to_last, days_to_next,
         CASE WHEN days_to_last != 1 OR days_to_last IS NULL 
         THEN date ELSE 'NOT A START DATE' END AS start_date
         FROM period_state WHERE period_state = 'failed')T1
     WHERE start_date != 'NOT A START DATE')T2
    LEFT JOIN
    (SELECT date, end_date, ROW_NUMBER() OVER(ORDER BY date) AS row_num
     FROM
        (SELECT date, period_state, days_to_last, days_to_next,
                CASE WHEN days_to_next != 1 OR days_to_next IS NULL 
                THEN date ELSE 'NOT A END DATE' END AS end_date
         FROM period_state WHERE period_state = 'failed')T3
     WHERE end_date != 'NOT A END DATE' )T4
     ON T2.row_num = T4.row_num

UNION ALL

SELECT T6.period_state, start_date, end_date
FROM
    (SELECT period_state, date, start_date, ROW_NUMBER() OVER(ORDER BY date) AS row_num
     FROM
        (SELECT date, period_state, days_to_last, days_to_next,
                CASE WHEN days_to_last != 1 OR days_to_last IS NULL 
                THEN date ELSE 'NOT A START DATE' END AS start_date
         FROM period_state WHERE period_state = 'succeeded')T5
     WHERE start_date != 'NOT A START DATE')T6
    LEFT JOIN
    (SELECT date, end_date, ROW_NUMBER() OVER(ORDER BY date) AS row_num
     FROM
        (SELECT date, period_state, days_to_last, days_to_next, 
                CASE WHEN days_to_next != 1 OR days_to_next IS NULL 
                THEN date ELSE 'NOT A END DATE' END AS end_date
         FROM period_state WHERE period_state = 'succeeded')T7
     WHERE end_date != 'NOT A END DATE')T8
     ON T6.row_num = T8.row_num)T9
ORDER BY start_date
```
##### [**Back to Question List**](#question-list)
[Q1225]:
https://leetcode.com/problems/report-contiguous-dates/

#### [**Q1336 Number of Transactions per Visit**][Q1336]
```sql
WITH T1 AS
    (SELECT user_id, transaction_date, COUNT(user_id) AS tran_user_day
     FROM Transactions
     GROUP BY user_id, transaction_date
     ORDER BY user_id, transaction_date),
     T2 AS
     (SELECT tran_cnt
      FROM
        (SELECT ROW_NUMBER() OVER(PARTITION BY NULL) -1 AS tran_cnt 
         FROM Transactions UNION
         SELECT ROW_NUMBER() OVER(PARTITION BY NULL)
         FROM Transactions)T3
      WHERE tran_cnt <= (SELECT MAX(tran_user_day) FROM T1)
      UNION SELECT 0)

SELECT T2.tran_cnt AS transactions_count, COALESCE(visits,0) AS visits_count
FROM T2 LEFT JOIN
   (SELECT COALESCE(tran_user_day,0) AS trans_cnt, COUNT(Visits.user_id) AS visits
    FROM Visits LEFT JOIN T1 
    ON Visits.user_id = T1.user_id AND Visits.visit_date = T1.transaction_date
    GROUP BY COALESCE(tran_user_day,0))T3
ON T2.tran_cnt = T3.trans_cnt
```
##### [**Back to Question List**](#question-list)
[Q1336]:
https://leetcode.com/problems/number-of-transactions-per-visit/

#### [**Q1369 Get the Second Most Recent Activity**][Q1369]
```sql
WITH Activity AS(
SELECT username, activity, startDate, endDate, 
       COUNT(activity) OVER(PARTITION BY username) AS act_cnt,
       ROW_NUMBER() OVER(PARTITION BY username ORDER BY startDate DESC) AS act_rank
FROM UserActivity)

SELECT username, activity, startDate, endDate
FROM Activity WHERE act_cnt = 1
UNION
SELECT username, activity, startDate, endDate
FROM Activity WHERE act_rank = 2
```
##### [**Back to Question List**](#question-list)
[Q1369]:
https://leetcode.com/problems/get-the-second-most-recent-activity/

#### [**Q1384 Total Sales Amount by Year**][Q1384]
```sql
WITH ann_sales AS(
    SELECT product_id, average_daily_sales, period_start, period_end, 
       LEFT(period_end,4) - LEFT(period_start, 4) AS yr_diff
    FROM Sales),
    
    sales_by_yr AS(
    SELECT product_id, average_daily_sales, LEFT(period_start, 4) AS report_year,
           DATEDIFF(period_end, period_start)+1 AS sales_days
    FROM ann_sales WHERE yr_diff = 0

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_start, 4) AS report_year,
           DATEDIFF(DATE("2018-12-31"), period_start)+1 AS sales_days
    FROM ann_sales WHERE yr_diff = 1 AND period_start <= DATE('2018-12-31')

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_end, 4) AS report_year, 
           DATEDIFF(period_end, DATE("2019-01-01"))+1 AS sales_days
    FROM ann_sales WHERE yr_diff = 1 AND period_start <= DATE('2018-12-31')

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_start, 4) AS report_year, 
           DATEDIFF(DATE("2019-12-31"), period_start)+1 AS sales_days
    FROM ann_sales 
    WHERE yr_diff = 1 
    AND period_start <= DATE('2019-12-31')
    AND period_start >= DATE('2019-01-01')

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_end, 4) AS report_year, 
           DATEDIFF(period_end, DATE("2020-01-01"))+1 AS sales_days
    FROM ann_sales 
    WHERE yr_diff = 1 
    AND period_start <= DATE('2019-12-31')
    AND period_start >= DATE('2019-01-01')

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_start, 4) AS report_year, 
           DATEDIFF(DATE("2018-12-31"), period_start)+1 AS sales_days
    FROM ann_sales 
    WHERE yr_diff = 2
    

    UNION ALL

    SELECT product_id, average_daily_sales, 2019 AS report_year, 
           DATEDIFF(DATE("2019-12-31"), DATE('2019-01-01'))+1 AS sales_days
    FROM ann_sales 
    WHERE yr_diff = 2

    UNION ALL

    SELECT product_id, average_daily_sales, LEFT(period_end, 4) AS report_year, 
           DATEDIFF(period_end, DATE("2020-01-01"))+1 AS sales_days
    FROM ann_sales 
    WHERE yr_diff = 2)
    
SELECT sales_by_yr.product_id, MIN(product_name) AS product_name, report_year, 
       SUM(average_daily_sales * sales_days) AS total_amount
FROM sales_by_yr LEFT JOIN Product
ON sales_by_yr.product_id = Product.product_id
GROUP BY sales_by_yr.product_id, report_year
ORDER BY product_id, report_year
```
##### [**Back to Question List**](#question-list)
[Q1384]:
https://leetcode.com/problems/total-sales-amount-by-year/

#### [**Q1412 Find the Quiet Students in All Exams**][Q1412]
```sql
WITH score AS(
SELECT exam_id, student_id, score, 
       MIN(score) OVER(PARTITION BY exam_id) AS lowest_exam,
       MAX(score) OVER(PARTITION BY exam_id) AS highest_exam
FROM Exam)

SELECT DISTINCT score.student_id, student_name
FROM score LEFT JOIN Student
ON score.student_id = Student.student_id
WHERE score.student_id NOT IN (SELECT DISTINCT student_id FROM score WHERE score = lowest_exam OR score = highest_exam)
```
##### [**Back to Question List**](#question-list)
[Q1412]:
https://leetcode.com/problems/find-the-quiet-students-in-all-exams/

#### [**Q1479 Sales by Day of the Week**][Q1479]
```sql
WITH     
    pivot AS(
    SELECT item_id, 
           CASE DAYOFWEEK(order_date) WHEN 2 THEN quantity ELSE 0 END Monday,
           CASE DAYOFWEEK(order_date) WHEN 3 THEN quantity ELSE 0 END Tuesday,
           CASE DAYOFWEEK(order_date) WHEN 4 THEN quantity ELSE 0 END Wednesday,
           CASE DAYOFWEEK(order_date) WHEN 5 THEN quantity ELSE 0 END Thursday,
           CASE DAYOFWEEK(order_date) WHEN 6 THEN quantity ELSE 0 END Friday,
           CASE DAYOFWEEK(order_date) WHEN 7 THEN quantity ELSE 0 END Saturday,
           CASE DAYOFWEEK(order_date) WHEN 1 THEN quantity ELSE 0 END Sunday
    FROM Orders)
 

SELECT item_Category AS category, COALESCE(SUM(Monday),0) AS Monday,
                    COALESCE(SUM(Tuesday),0) AS Tuesday,
                    COALESCE(SUM(Wednesday),0) AS Wednesday,
                    COALESCE(SUM(Thursday),0) AS Thursday,
                    COALESCE(SUM(Friday),0) AS Friday,
                    COALESCE(SUM(Saturday),0) AS Saturday,
                    COALESCE(SUM(Sunday),0) AS Sunday
FROM Items
LEFT JOIN  
    (SELECT item_id, SUM(Monday) AS Monday, SUM(Tuesday) AS Tuesday, SUM(Wednesday) AS Wednesday,
            SUM(Thursday) AS Thursday, SUM(Friday) AS Friday, SUM(Saturday) AS Saturday,
            SUM(Sunday) AS Sunday
     FROM pivot
     GROUP BY item_id)T2
ON  Items.item_id = T2.item_id
GROUP BY item_Category
ORDER BY item_Category
```
##### [**Back to Question List**](#question-list)
[Q1479]:
https://leetcode.com/problems/sales-by-day-of-the-week/
